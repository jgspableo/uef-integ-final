<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>UEF Bootstrap</title>
  </head>
  <body>
    <script>
      // Injected by server.js
      const LEARN_HOST = "%%LEARN_HOST%%";
      const REST_TOKEN = "%%REST_TOKEN%%";
      const TOOL_BASE_URL = "%%TOOL_BASE_URL%%";
      const PORTAL_TITLE = "%%PORTAL_TITLE%%";

      console.log("UEF bootstrap loaded");

      // 1) Ask Ultra for a MessagePort (MessageChannel)
      function requestPort() {
        window.parent.postMessage(
          { type: "integration:hello" },
          LEARN_HOST
        );
      }

      let port = null;

      window.addEventListener("message", (event) => {
        // Only accept from the Learn host
        if (event.origin !== LEARN_HOST) return;

        // Ultra will respond with a MessagePort in event.ports[0]
        if (event.ports && event.ports.length > 0) {
          port = event.ports[0];
          console.log("âœ… UEF MessagePort acquired");

          port.onmessage = onPortMessage;

          authorizeAndRegister();
        }
      });

      function post(msg) {
        if (!port) return;
        port.postMessage(msg);
      }

      function authorizeAndRegister() {
        // 2) Authorize (YOU send this; Ultra expects it) :contentReference[oaicite:10]{index=10}
        post({
          type: "authorization:authorize",
          token: REST_TOKEN
        });

        console.log("âž¡ï¸ Sent authorization:authorize");

        // 3) Subscribe to portal events (needed to render Course Details portal) :contentReference[oaicite:11]{index=11}
        post({
          type: "event:subscribe",
          subscriptions: ["portal-new", "portal-remove"]
        });

        console.log("âž¡ï¸ Subscribed to portal events");

        // 4) Register a Course Details integration :contentReference[oaicite:12]{index=12}
        post({
          type: "course:detail:register",
          registrationName: PORTAL_TITLE
        });

        console.log("âž¡ï¸ Sent course:detail:register");
      }

      function onPortMessage(evt) {
        const data = evt.data;
        if (!data || typeof data !== "object") return;

        // Portal events come as { type: 'event:event', portalId, eventType, ... } :contentReference[oaicite:13]{index=13}
        if (data.type === "event:event" && data.portalId) {
          if (data.eventType === "new") {
            console.log("ðŸ§© Portal NEW:", data.portalId, data);

            // Render an iframe in that portal :contentReference[oaicite:14]{index=14}
            post({
              type: "portal:render",
              portalId: data.portalId,
              contents: {
                tag: "iframe",
                props: {
                  src: `${TOOL_BASE_URL}/chat.html`,
                  style: {
                    width: "100%",
                    height: "520px",
                    border: "0"
                  }
                }
              }
            });

            console.log("âœ… portal:render sent");
          }
        }
      }

      // Keep trying until Ultra responds with a port (no infinite spam)
      let tries = 0;
      const t = setInterval(() => {
        tries++;
        requestPort();
        if (port || tries > 15) clearInterval(t);
        console.log(`Knocking... (${tries})`);
      }, 1200);
    </script>
  </body>
</html>
