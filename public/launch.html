<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,maximum-scale=1"
    />
    <title>UEF Launcher</title>
    <style>
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        margin: 16px;
      }
      .muted {
        opacity: 0.7;
        font-size: 12px;
      }
      pre {
        background: #111;
        color: #0f0;
        padding: 12px;
        border-radius: 10px;
        overflow: auto;
        max-height: 45vh;
      }
      .ok {
        color: #0a0;
        font-weight: 700;
      }
      .warn {
        color: #b58900;
        font-weight: 700;
      }
      .err {
        color: #c00;
        font-weight: 700;
      }
    </style>
  </head>

  <body>
    <h2>UEF bootstrap loaded</h2>
    <div class="muted">
      This page should be launched from Learn (inside an iframe). If you open it
      directly, UEF messages won‚Äôt connect.
    </div>

    <pre id="log"></pre>

    <script>
      /************************************************************
       * Injected by server.js via %%VAR%% replacement
       ************************************************************/
      const LEARN_HOST = "%%LEARN_HOST%%"; // e.g. https://mapua-test.blackboard.com
      const REST_TOKEN = "%%REST_TOKEN%%"; // bearer token your server got
      const TOOL_BASE_URL = "%%TOOL_BASE_URL%%"; // e.g. https://uef-integ-final.onrender.com
      const PORTAL_TITLE = "%%PORTAL_TITLE%%"; // display label

      /************************************************************
       * YOU MUST SET THIS:
       * Use the Placement "Handle" from Admin -> LTI Tool Providers -> Manage Placements
       * Pick the placement that renders your widget (Course content tool / Course navigation tool).
       ************************************************************/
      const LTI_PLACEMENT_HANDLE = "%%LTI_PLACEMENT_HANDLE%%"; // <-- set/inject this

      // Optional IDs (stable strings)
      const HELP_ID = "nf-help";
      const COURSE_DETAIL_ID = "nf-mappy-widget";

      /************************************************************
       * Logger
       ************************************************************/
      const $log = document.getElementById("log");
      function log(...args) {
        const line = args
          .map((a) => (typeof a === "string" ? a : JSON.stringify(a, null, 2)))
          .join(" ");
        $log.textContent += line + "\n";
        console.log(...args);
      }

      /************************************************************
       * UEF MessagePort handshake (MessageChannel)
       *
       * Anthology docs show this ‚Äúintegration-hello‚Äù pattern for obtaining a port.
       * In practice, some installs respond to integration:hello-style echoes too,
       * so we accept either.
       ************************************************************/
      function acquireMessagePort() {
        return new Promise((resolve, reject) => {
          let resolved = false;

          // 1) Create channel we will hand to Learn
          const channel = new MessageChannel();

          // 2) If Learn responds on our port, we are connected
          channel.port1.onmessage = (event) => {
            const data = event.data || {};
            // Some systems echo a message back; even without it, port being active is enough.
            if (!resolved) {
              resolved = true;
              log("‚úÖ UEF MessagePort acquired");
              resolve(channel.port1);
            }
          };

          // 3) Keep knocking until Learn binds the port
          let attempt = 0;
          const timer = setInterval(() => {
            attempt++;
            if (attempt === 1 || attempt % 5 === 0) {
              log(`üëã Knocking... (Attempt ${attempt})`);
            }

            try {
              // Docs use type: "integration-hello" with port2 transferred
              // We'll do that. (Some instances also accept "integration:hello".)
              window.parent.postMessage(
                { type: "integration-hello" },
                LEARN_HOST,
                [channel.port2]
              );
            } catch (e) {
              // If target origin mismatch causes issues, try wildcard as last resort
              try {
                window.parent.postMessage(
                  { type: "integration-hello" },
                  "*",
                  [channel.port2]
                );
              } catch (e2) {
                // ignore
              }
            }

            // Safety stop (avoid infinite loop if user opens directly)
            if (attempt > 60 && !resolved) {
              clearInterval(timer);
              reject(
                new Error(
                  "UEF MessagePort not acquired. Make sure launch is happening inside Learn (Ultra) and UEF is enabled."
                )
              );
            }
          }, 2000);

          // If promise resolves/rejects, stop the timer
          const stop = () => clearInterval(timer);
          channel.port1.addEventListener("message", stop, { once: true });
        });
      }

      /************************************************************
       * Send wrappers
       ************************************************************/
      function send(port, msg) {
        port.postMessage(msg);
      }

      /************************************************************
       * Main
       ************************************************************/
      (async function main() {
        try {
          log("LEARN_HOST =", LEARN_HOST);
          log("TOOL_BASE_URL =", TOOL_BASE_URL);

          if (!REST_TOKEN || REST_TOKEN.startsWith("%%")) {
            log("‚ùå Missing REST_TOKEN injection.");
            return;
          }

          if (!LTI_PLACEMENT_HANDLE || LTI_PLACEMENT_HANDLE.startsWith("%%")) {
            log(
              "‚ö†Ô∏è LTI_PLACEMENT_HANDLE is not set. Course link will register, but launch may not work."
            );
          }

          // 1) Get UEF MessagePort
          const port = await acquireMessagePort();

          // Optional: print everything Learn sends us
          port.onmessage = (event) => {
            const data = event.data;
            if (!data) return;
            // Filter noisy heartbeats if any
            if (data.type === "integration:hello") return;
            log("üì© Message from Learn:", data);
          };

          // 2) Authorize UEF actions (needs bearer token)
          log("‚û°Ô∏è Sent authorization:authorize");
          send(port, {
            type: "authorization:authorize",
            payload: {
              token: REST_TOKEN,

              // If your environment enforces scopes strictly, you may need
              // portal/help scopes for the features below.
              // (Keep as-is unless your Learn rejects authorization.)
              auth_types: ["ultra:portal", "ultra:help"],
            },
          });

          // 3) (Optional) Register Help Provider item
          // If you don‚Äôt want it, you can delete this block.
          log("‚û°Ô∏è Sent integration:help:register");
          send(port, {
            type: "integration:help:register",
            payload: {
              id: HELP_ID,
              title: PORTAL_TITLE || "NoodleFactory Chat",
              url: `${TOOL_BASE_URL}/chat`,
            },
          });

          // 4) Register Course Details & Actions link (shows inside a course)
          log("‚û°Ô∏è Sent course:detail:register");
          send(port, {
            type: "course:detail:register",
            payload: {
              id: COURSE_DETAIL_ID,
              title: PORTAL_TITLE || "Mappy Widget",
              // Blackboard uses the placement handle to know which LTI placement to launch
              handle: LTI_PLACEMENT_HANDLE,
            },
          });

          log("‚úÖ Done: waiting for Learn events...");
        } catch (e) {
          log("‚ùå ERROR:", e?.message || String(e));
        }
      })();
    </script>
  </body>
</html>
