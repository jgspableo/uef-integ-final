<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UEF Bootstrap</title>
    <style>
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        margin: 24px;
      }
      .card {
        max-width: 980px;
        padding: 18px;
        border: 1px solid #ddd;
        border-radius: 10px;
      }
      pre {
        background: #0b0b0b;
        color: #9cff9c;
        padding: 14px;
        border-radius: 10px;
        overflow: auto;
      }
      .warn { color: #ffcc66; }
      .ok { color: #9cff9c; }
    </style>
  </head>

  <body>
    <div class="card">
      <h2>UEF bootstrap loaded</h2>
      <p>
        This page should be launched from Learn (inside an iframe). If you open it directly,
        UEF messages wonâ€™t connect.
      </p>

      <pre id="log"></pre>
    </div>

    <script>
      const LEARN_HOST = "%%LEARN_HOST%%";
      const TOOL_BASE_URL = "%%TOOL_BASE_URL%%";
      const PORTAL_TITLE = "%%PORTAL_TITLE%%";
      const REST_TOKEN = "%%REST_TOKEN%%";
      const LTI_PLACEMENT_HANDLE = "%%LTI_PLACEMENT_HANDLE%%";
      const CHAT_LAUNCH_URL = "%%CHAT_LAUNCH_URL%%";

      const logEl = document.getElementById("log");
      function log(line) {
        logEl.textContent += line + "\n";
        console.log(line);
      }

      log("UEF bootstrap loaded");
      log(`LEARN_HOST = ${LEARN_HOST}`);
      log(`TOOL_BASE_URL = ${TOOL_BASE_URL}`);
      if (!LTI_PLACEMENT_HANDLE || LTI_PLACEMENT_HANDLE === "%%LTI_PLACEMENT_HANDLE%%") {
        log("âš ï¸ LTI_PLACEMENT_HANDLE is not set (optional).");
      } else {
        log(`LTI_PLACEMENT_HANDLE = ${LTI_PLACEMENT_HANDLE}`);
      }

      let port = null;
      let attempts = 0;
      let helloTimer = null;

      // Listen for the initial MessagePort handoff.
      window.addEventListener("message", (event) => {
        const data = event.data;

        // Some Learn builds used integration-hello, others integration:hello; accept both.
        if (data?.type !== "integration:hello" && data?.type !== "integration-hello") return;

        const maybePort = event.ports && event.ports[0];
        if (!maybePort) {
          log("âš ï¸ integration hello received but no MessagePort attached.");
          return;
        }

        if (port) return; // already have it
        port = maybePort;
        port.onmessage = onPortMessage;
        port.start();

        log("âœ… UEF MessagePort acquired");
        if (helloTimer) clearInterval(helloTimer);

        // Authorize (REST token)
        port.postMessage({
          type: "authorization:authorize",
          payload: { token: REST_TOKEN },
        });
        log("âž¡ï¸ Sent authorization:authorize");

        // Subscribe to portal events (optional)
        port.postMessage({ type: "portal:events:subscribe" });
        log("âž¡ï¸ Subscribed to portal events");

        // Register help entry (this is the most reliable â€œvisibleâ€ UEF surface)
        port.postMessage({
          type: "integration:help:register",
          payload: {
            id: "noodle-factory-chat",
            title: PORTAL_TITLE,
            url: CHAT_LAUNCH_URL,
          },
        });
        log("âž¡ï¸ Sent integration:help:register (opens widget)");
      });

      function onPortMessage(evt) {
        const data = evt.data;
        log(`â¬…ï¸ PORT MSG: ${JSON.stringify(data)}`);

        // Some systems respond after authorization
        if (data?.type === "authorization:authorized") {
          log("âœ… Authorized with Learn");
        }
      }

      // Keep knocking until Learn hands us a MessagePort
      helloTimer = setInterval(() => {
        attempts++;
        if (attempts === 1 || attempts % 5 === 0) {
          log(`ðŸ‘‹ Knocking... (Attempt ${attempts})`);
        }
        window.parent.postMessage({ type: "integration:hello" }, "*");
        window.parent.postMessage({ type: "integration-hello" }, "*");
      }, 2000);
    </script>
  </body>
</html>
